name: Survey Preview - PR é è¦½éƒ¨ç½²

on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/survey-frontend/**'
      - 'packages/sdk/**'

jobs:
  build-preview:
    name: å»ºç½® PR é è¦½
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ å»ºç½® SDK
        run: |
          cd packages/sdk
          pnpm run build

      - name: ğŸ—ï¸ å»ºç½® Survey å‰ç«¯ï¼ˆStagingï¼‰
        env:
          VITE_API_BASE: https://pos-backend-staging.survey-api.workers.dev
          VITE_LIFF_ID: ${{ secrets.VITE_LIFF_ID || '2007900041-O9ayn5JW' }}
        run: |
          cd packages/survey-frontend
          echo "VITE_API_BASE=$VITE_API_BASE" > .env.production
          echo "VITE_LIFF_ID=$VITE_LIFF_ID" >> .env.production
          pnpm run build

      - name: ğŸ“¤ ä¸Šå‚³å»ºç½®ç”¢ç‰©ï¼ˆArtifactï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: survey-preview-${{ github.event.pull_request.number }}
          path: packages/survey-frontend/dist
          retention-days: 7

      - name: ğŸ’¬ ç•™è¨€é è¦½é€£çµ
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const comment = `## ğŸ‰ Survey é è¦½å»ºç½®å®Œæˆï¼
            
            **PR #${prNumber}** çš„ Survey å‰ç«¯å·²æˆåŠŸå»ºç½®ã€‚
            
            ### ğŸ“¦ å»ºç½®ç”¢ç‰©
            - å»ºç½®ç”¢ç‰©å·²ä¸Šå‚³ç‚º Artifact: \`survey-preview-${prNumber}\`
            - ä¿ç•™æœŸé™: 7 å¤©
            
            ### ğŸ§ª æœ¬åœ°æ¸¬è©¦
            1. ä¸‹è¼‰ Artifact
            2. è§£å£“ç¸®åˆ°ä»»æ„ç›®éŒ„
            3. ä½¿ç”¨éœæ…‹ä¼ºæœå™¨é è¦½ï¼š
               \`\`\`bash
               npx serve dist
               \`\`\`
            
            ### âœ… å“è³ªæª¢æŸ¥
            - Lint: âœ… é€šé
            - TypeScript: âœ… é€šé
            - Build: âœ… æˆåŠŸ
            
            ---
            _æ­¤é è¦½ä½¿ç”¨ Staging API: \`https://pos-backend-staging.survey-api.workers.dev\`_
            `;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

