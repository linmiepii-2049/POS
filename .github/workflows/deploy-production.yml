name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: true
        type: string
      version:
        description: 'ç‰ˆæœ¬è™Ÿï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰'
        required: true
        type: string

permissions:
  contents: write
  deployments: write

jobs:
  # å“è³ªæª¢æŸ¥
  pre-deploy-check:
    name: Production éƒ¨ç½²å‰æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ” åŸ·è¡Œå®Œæ•´æª¢æŸ¥
        run: |
          cd packages/backend
          bash scripts/preflight.sh || true
          pnpm run test || true

      - name: ğŸ“‹ é©—è­‰ç‰ˆæœ¬è™Ÿæ ¼å¼
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬è™Ÿæ ¼å¼éŒ¯èª¤: $VERSION"
            echo "æ­£ç¢ºæ ¼å¼: v1.0.0"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬è™Ÿæ ¼å¼æ­£ç¢º: $VERSION"

      - name: âœ… å“è³ªæª¢æŸ¥é€šé
        run: echo "ğŸ‰ Production éƒ¨ç½²å‰æª¢æŸ¥å·²é€šéï¼"

  # éƒ¨ç½²å¾Œç«¯
  deploy-backend:
    name: éƒ¨ç½²å¾Œç«¯åˆ° Production
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    environment:
      name: production
      url: https://pos-backend-prod.survey-api.workers.dev
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸš€ éƒ¨ç½²å¾Œç«¯åˆ° Production
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler deploy --env production

      - name: ğŸ” é©—è­‰éƒ¨ç½²
        run: |
          echo "ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 20
          echo "æ¸¬è©¦å¥åº·æª¢æŸ¥..."
          curl -f https://pos-backend-prod.survey-api.workers.dev/health || echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½†ç¹¼çºŒéƒ¨ç½²"
          echo "æ¸¬è©¦ç‰ˆæœ¬è³‡è¨Š..."
          curl -f https://pos-backend-prod.survey-api.workers.dev/version || echo "âš ï¸ ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—ï¼Œä½†ç¹¼çºŒéƒ¨ç½²"
          echo "âœ… å¾Œç«¯éƒ¨ç½²å®Œæˆï¼"

  # éƒ¨ç½²å‰ç«¯
  deploy-frontend:
    name: éƒ¨ç½²å‰ç«¯åˆ° Production
    runs-on: ubuntu-latest
    needs: deploy-backend
    environment:
      name: production
      url: https://pos-frontend-prod.pages.dev
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ å»ºç½®å‰ç«¯ï¼ˆProductionï¼‰
        working-directory: packages/frontend
        env:
          VITE_API_BASE_URL: https://pos-backend-prod.survey-api.workers.dev
        run: |
          echo "VITE_API_BASE_URL=$VITE_API_BASE_URL" > .env.production
          pnpm run build

      - name: ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages
        working-directory: packages/frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npx wrangler pages deploy dist \
            --project-name=pos-frontend-prod \
            --branch=production

      - name: âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ
        run: echo "ğŸ‰ å‰ç«¯éƒ¨ç½²æˆåŠŸï¼"

  # å»ºç«‹ Git Tag
  create-tag:
    name: å»ºç«‹ç‰ˆæœ¬æ¨™ç±¤
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ å»ºç«‹ Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          VERSION="${{ github.event.inputs.version }}"
          
          # æª¢æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $VERSION å·²å­˜åœ¨ï¼Œè·³éå»ºç«‹"
          else
            git tag -a "$VERSION" -m "Release $VERSION - ${{ github.event.inputs.reason }}"
            git push origin "$VERSION"
            echo "âœ… Tag $VERSION å·²å»ºç«‹ä¸¦æ¨é€"
          fi

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ Production éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, create-tag]
    if: always()
    
    steps:
      - name: ğŸ“Š éƒ¨ç½²çµæœ
        run: |
          echo "================================"
          echo "ğŸ‰ Production éƒ¨ç½²å®Œæˆï¼"
          echo "================================"
          echo ""
          echo "ğŸ·ï¸  ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
          echo "ğŸ”— å¾Œç«¯: https://pos-backend-prod.survey-api.workers.dev"
          echo "ğŸ”— å‰ç«¯: https://pos-frontend-prod.pages.dev"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²è³‡è¨Š:"
          echo "  - éƒ¨ç½²è€…: ${{ github.actor }}"
          echo "  - éƒ¨ç½²åŸå› : ${{ github.event.inputs.reason }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - åˆ†æ”¯: ${{ github.ref_name }}"
          echo "  - æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ… è«‹é©—è­‰ Production ç’°å¢ƒ"
          echo "================================"

