name: CI - å“è³ªæª¢æŸ¥

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality-check:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ” å¾Œç«¯ - ESLint æª¢æŸ¥
        run: |
          cd packages/backend
          pnpm run lint

      - name: ğŸ” å¾Œç«¯ - TypeScript å‹åˆ¥æª¢æŸ¥
        run: |
          cd packages/backend
          pnpm run typecheck

      - name: ğŸ“‹ å¾Œç«¯ - ç”Ÿæˆ OpenAPI æ–‡æª”
        run: |
          cd packages/backend
          pnpm run openapi

      - name: ğŸ“‹ å¾Œç«¯ - OpenAPI Spectral é©—è­‰
        run: |
          cd packages/backend
          npx @stoplight/spectral-cli lint docs/openapi.json --ruleset docs/.spectral.yaml || true

      - name: ğŸ§ª å¾Œç«¯ - åŸ·è¡Œæ¸¬è©¦
        run: |
          cd packages/backend
          pnpm run test || true

      - name: ğŸ” å‰ç«¯ - ESLint æª¢æŸ¥
        run: |
          cd packages/frontend
          pnpm run lint

      - name: ğŸ” å‰ç«¯ - TypeScript å‹åˆ¥æª¢æŸ¥
        run: |
          cd packages/frontend
          pnpm run typecheck

      - name: ğŸ§ª å‰ç«¯ - åŸ·è¡Œæ¸¬è©¦
        run: |
          cd packages/frontend
          pnpm run test:run || true

      - name: âœ… å“è³ªæª¢æŸ¥é€šé
        run: echo "ğŸ‰ æ‰€æœ‰å“è³ªæª¢æŸ¥å·²é€šéï¼"

  build-check:
    name: å»ºç½®æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ å‰ç«¯ - å»ºç½®æª¢æŸ¥
        run: |
          cd packages/frontend
          pnpm run build

      - name: âœ… å»ºç½®æª¢æŸ¥é€šé
        run: echo "ğŸ‰ å»ºç½®æª¢æŸ¥å·²é€šéï¼"

