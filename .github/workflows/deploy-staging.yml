name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: true
        type: string

# è¨­å®šæ¬Šé™
permissions:
  contents: read
  deployments: write

jobs:
  # å“è³ªæª¢æŸ¥
  pre-deploy-check:
    name: éƒ¨ç½²å‰å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ” åŸ·è¡Œ Preflight æª¢æŸ¥
        run: |
          cd packages/backend
          bash scripts/preflight.sh || true

      - name: âœ… å“è³ªæª¢æŸ¥é€šé
        run: echo "ğŸ‰ éƒ¨ç½²å‰æª¢æŸ¥å·²é€šéï¼"

  # éƒ¨ç½²å¾Œç«¯
  deploy-backend:
    name: éƒ¨ç½²å¾Œç«¯åˆ° Staging
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    environment:
      name: staging
      url: https://pos-backend-staging.survey-api.workers.dev
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ æª¢æŸ¥ D1 è³‡æ–™åº«ç‹€æ…‹
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æª¢æŸ¥ Staging D1 è³‡æ–™åº«ç‹€æ…‹..."
          if npx wrangler d1 migrations list DB --env staging --remote 2>&1 | grep -q "no such database\|error\|Error"; then
            echo "âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®"
            exit 1
          else
            echo "âœ… D1 è³‡æ–™åº«é€£æ¥æ­£å¸¸"
          fi

      - name: ğŸ”„ åŸ·è¡Œ D1 Migrations
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æª¢æŸ¥æ˜¯å¦æœ‰ pending migrations..."
          MIGRATION_OUTPUT=$(npx wrangler d1 migrations list DB --env staging --remote 2>&1 || echo "")
          
          if echo "$MIGRATION_OUTPUT" | grep -q "Migrations to be applied"; then
            echo "âš ï¸ ç™¼ç¾ pending migrationsï¼Œé–‹å§‹åŸ·è¡Œ..."
            echo "Pending migrations åˆ—è¡¨:"
            echo "$MIGRATION_OUTPUT" | grep -A 100 "Migrations to be applied" || echo "$MIGRATION_OUTPUT"
            echo ""
            
            echo "åŸ·è¡Œ migrationsï¼ˆé€™å¯èƒ½éœ€è¦å¹¾ç§’é˜ï¼‰..."
            if npx wrangler d1 migrations apply DB --env staging --remote; then
              echo "âœ… Migrations åŸ·è¡Œå®Œæˆ"
            else
              echo "âŒ Migrations åŸ·è¡Œå¤±æ•—"
              exit 1
            fi
          else
            echo "âœ… æ‰€æœ‰ migrations å·²æ˜¯æœ€æ–°"
          fi

      - name: ğŸ“¦ æª¢æŸ¥ R2 Bucket ç‹€æ…‹
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æª¢æŸ¥ Staging R2 bucket..."
          if npx wrangler r2 bucket list | grep -q "pos-assets-staging"; then
            echo "âœ… R2 bucket 'pos-assets-staging' å­˜åœ¨"
          else
            echo "âš ï¸ R2 bucket 'pos-assets-staging' ä¸å­˜åœ¨ï¼Œè«‹å…ˆå»ºç«‹"
            echo "åŸ·è¡Œ: npx wrangler r2 bucket create pos-assets-staging"
            exit 1
          fi

      - name: ğŸš€ éƒ¨ç½²å¾Œç«¯åˆ° Staging
        working-directory: packages/backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GIT_SHA: ${{ github.sha }}
        run: |
          echo "é–‹å§‹éƒ¨ç½²åˆ° Staging..."
          npx wrangler deploy --env staging
          echo "âœ… Workers éƒ¨ç½²å®Œæˆ"

      - name: ğŸ” é©—è­‰éƒ¨ç½²
        run: |
          echo "ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
          sleep 20
          
          echo "æ¸¬è©¦å¥åº·æª¢æŸ¥ï¼ˆé‡è©¦ 3 æ¬¡ï¼‰..."
          for i in 1 2 3; do
            if curl -f https://pos-backend-staging.survey-api.workers.dev/health; then
              echo "âœ… å¥åº·æª¢æŸ¥æˆåŠŸï¼"
              break
            else
              echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—ï¼ˆç¬¬ $i æ¬¡ï¼‰ï¼Œ10 ç§’å¾Œé‡è©¦..."
              sleep 10
            fi
          done
          
          echo "æ¸¬è©¦ç‰ˆæœ¬è³‡è¨Š..."
          curl -f https://pos-backend-staging.survey-api.workers.dev/version || echo "âš ï¸ ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—"
          
          echo "âœ… å¾Œç«¯éƒ¨ç½²å®Œæˆï¼"

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: always()
    
    steps:
      - name: ğŸ“Š éƒ¨ç½²çµæœ
        run: |
          echo "================================"
          echo "ğŸ‰ Staging å¾Œç«¯éƒ¨ç½²å®Œæˆï¼"
          echo "================================"
          echo ""
          echo "ğŸ”— å¾Œç«¯: https://pos-backend-staging.survey-api.workers.dev"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²è³‡è¨Š:"
          echo "  - éƒ¨ç½²è€…: ${{ github.actor }}"
          echo "  - éƒ¨ç½²åŸå› : ${{ github.event.inputs.reason }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - åˆ†æ”¯: ${{ github.ref_name }}"
          echo ""
          echo "â„¹ï¸  å‰ç«¯å·²ç§»è‡³ Vercel è‡ªå‹•éƒ¨ç½²"
          echo "âœ… è«‹é©—è­‰å¾Œç«¯éƒ¨ç½²çµæœ"
          echo "================================"

